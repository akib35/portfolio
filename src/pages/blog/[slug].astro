---
import Layout from '../../layouts/Layout.astro';

interface BlogPost {
  title: string;
  date: string;
  excerpt: string;
  slug: string;
  content: string;
}

const modules = import.meta.glob<{ frontmatter: Record<string, any>; default: string }>('../../data/blog/*.md', { eager: true });

const posts: BlogPost[] = [];

for (const path in modules) {
  const module = modules[path];
  const slug = path.split('/').pop()?.replace('.md', '') || '';
  
  if (module.frontmatter) {
    posts.push({
      slug,
      title: module.frontmatter.title || 'Untitled',
      date: module.frontmatter.date || new Date().toISOString(),
      excerpt: module.frontmatter.excerpt || '',
      content: module.default || '',
    });
  }
}

export function getStaticPaths() {
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

interface Props {
  post: BlogPost;
}

const { post } = Astro.props;

// Simple markdown to HTML converter
function markdownToHtml(markdown: string): string {
  let html = markdown;
  
  // Headers
  html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
  
  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // Italic
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
  
  // Code blocks
  html = html.replace(/```(.*?)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  
  // Inline code
  html = html.replace(/`(.*?)`/g, '<code>$1</code>');
  
  // Links
  html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
  
  // Paragraphs
  html = html.split('\n\n').map((para: string) => {
    if (para.startsWith('<h') || para.startsWith('<pre') || para.startsWith('<ul') || para.startsWith('<ol')) {
      return para;
    }
    return `<p>${para}</p>`;
  }).join('');
  
  // Lists
  html = html.replace(/^\* (.*?)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
  html = html.replace(/^\d+\. (.*?)$/gm, '<li>$1</li>');
  
  return html;
}

const htmlContent = markdownToHtml(post.content);
---

<Layout title={post.title}>
  <article class="container py-12 max-w-3xl">
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-3">{post.title}</h1>
      <p class="text-gray-600">
        {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
      </p>
    </header>

    <div class="prose prose-lg max-w-none">
      <Fragment set:html={htmlContent} />
    </div>

    <footer class="mt-12 pt-8 border-t border-gray-200">
      <a href="/blog" class="text-blue-600 hover:text-blue-700 font-medium">
        ‚Üê Back to Blog
      </a>
    </footer>
  </article>
</Layout>

<style>
  :global(.prose) {
    color: #111827;
    line-height: 1.75;
  }

  :global(.prose h2) {
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #111827;
  }

  :global(.prose h3) {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #1f2937;
  }

  :global(.prose p) {
    margin-bottom: 1rem;
  }

  :global(.prose a) {
    color: #2563eb;
    text-decoration: none;
  }

  :global(.prose a:hover) {
    color: #1d4ed8;
    text-decoration: underline;
  }

  :global(.prose code) {
    background-color: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.875rem;
  }

  :global(.prose pre) {
    background-color: #1f2937;
    color: #f3f4f6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
  }

  :global(.prose pre code) {
    background-color: transparent;
    color: inherit;
    padding: 0;
  }

  :global(.prose ul),
  :global(.prose ol) {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }

  :global(.prose li) {
    margin-bottom: 0.5rem;
  }

  :global(.prose blockquote) {
    border-left: 4px solid #2563eb;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #4b5563;
  }
</style>
