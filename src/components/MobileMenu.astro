---
import { getNavItemsWithState } from '../utils/navigation';

const currentPath = Astro.url.pathname;
const navItemsWithState = getNavItemsWithState(currentPath);
---

<!-- Mobile menu button -->
<button
  id="mobile-menu-button"
  type="button"
  class="md:hidden inline-flex items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
  aria-expanded="false"
  aria-controls="mobile-menu"
  aria-label="Open main menu"
>
  <!-- Hamburger icon -->
  <svg id="menu-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
  </svg>
  <!-- Close icon (hidden by default) -->
  <svg id="menu-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
  </svg>
</button>

<!-- Mobile menu panel -->
<div
  id="mobile-menu"
  class="md:hidden fixed inset-x-0 top-[73px] bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-lg transform -translate-y-full opacity-0 transition-all duration-300 ease-in-out z-40"
  aria-hidden="true"
>
  <nav class="container py-4">
    <ul class="space-y-1">
      {navItemsWithState.map(({ href, label, isActive }) => (
        <li>
          <a
            href={href}
            class:list={[
              "block px-4 py-3 rounded-lg text-base font-medium transition-colors no-underline",
              {
                "bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400": isActive,
                "text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700": !isActive
              }
            ]}
            aria-current={isActive ? "page" : undefined}
          >
            {label}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</div>

<script>
  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const iconOpen = document.getElementById('menu-icon-open');
    const iconClose = document.getElementById('menu-icon-close');

    if (!button || !menu || !iconOpen || !iconClose) return;

    let isOpen = false;

    function toggleMenu() {
      isOpen = !isOpen;

      if (isOpen) {
        menu.classList.remove('-translate-y-full', 'opacity-0');
        menu.classList.add('translate-y-0', 'opacity-100');
        menu.setAttribute('aria-hidden', 'false');
        button.setAttribute('aria-expanded', 'true');
        button.setAttribute('aria-label', 'Close main menu');
        iconOpen.classList.add('hidden');
        iconClose.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } else {
        menu.classList.add('-translate-y-full', 'opacity-0');
        menu.classList.remove('translate-y-0', 'opacity-100');
        menu.setAttribute('aria-hidden', 'true');
        button.setAttribute('aria-expanded', 'false');
        button.setAttribute('aria-label', 'Open main menu');
        iconOpen.classList.remove('hidden');
        iconClose.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    function closeMenu() {
      if (isOpen) {
        toggleMenu();
      }
    }

    button.addEventListener('click', toggleMenu);

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (isOpen && !menu.contains(e.target as Node) && !button.contains(e.target as Node)) {
        closeMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
        button.focus();
      }
    });

    // Close menu on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768 && isOpen) {
        closeMenu();
      }
    });

    // Close menu when navigating (for View Transitions)
    document.addEventListener('astro:before-preparation', closeMenu);
  }

  // Initialize on page load
  initMobileMenu();

  // Re-initialize after View Transitions
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
